var Timer Cloud_Test_Timer = null

rule "Restart cloud connector following an unsuccessful reconnection"
when
    Channel "logreader:reader:openhabcloud:newCustomEvent" triggered
then
    //Cancel any running timers. This is in case you have multiple disconnections/reconnections in a short time frame.
    Cloud_Test_Timer?.cancel

    //Set the testing status message
    myopenHAB_Connection.postUpdate("Testing")

    //Post a command to reset myopenHAB_Connection through the cloud
    Post_Test_Command.sendCommand(ON)

    //Wait 300 seconds, then restart the cloud connector if myopenHAB_Connection has not been updated to "Online" by the REST command
    Cloud_Test_Timer = createTimer(now.plusSeconds(300),
    [|
        if (myopenHAB_Connection.state == "Testing")
        {
            logInfo("openHAB Cloud", "Restarting cloud connector due to unsuccessful reconnection")
            sendNotification("cbattisson@gmail.com", "openHAB Cloud connector restarted")
            Restart_Cloud_Connector.sendCommand(ON)
        }
        else
        {
            logInfo("openHAB Cloud", "Successful reconnection to myopenHAB")
        }
    ])
end
